<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Meeting Test</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #202124; color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .controls { background: #3c4043; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #5f6368; background: #202124; color: white; }
        button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #8ab4f8; color: #202124; }
        button:hover { background: #aecbfa; }
        button.danger { background: #f28b82; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .video-card { background: #3c4043; border-radius: 8px; overflow: hidden; position: relative; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .card-label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-bar { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .icon { width: 24px; height: 24px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Video Meeting Test</h1>
            <div id="connectionStatus" style="color: #f28b82;">â€¢ Disconnected</div>
        </div>

        <div class="controls">
            <input type="text" id="roomId" value="room-general" placeholder="Room ID">
            <input type="text" id="userName" placeholder="Your Name">
            <button id="joinBtn" onclick="joinRoom()">Join Meeting</button>
            <button id="leaveBtn" onclick="leaveRoom()" class="danger" disabled>Leave</button>
            <div style="width: 20px;"></div>
            <button id="audioBtn" onclick="toggleAudio()" disabled>ðŸŽ¤ Mute</button>
            <button id="videoBtn" onclick="toggleVideo()" disabled>ðŸ“· Stop Video</button>
        </div>

        <div class="grid" id="videoGrid">
            <!-- Local Video -->
            <div class="video-card">
                <video id="localVideo" muted playsinline autoplay></video>
                <div class="card-label">You</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001';
        let socket;
        let localStream;
        let peerConnections = new Map();
        let isAudioMuted = false;
        let isVideoOff = false;
        let myUserId = 'user-' + Math.floor(Math.random() * 10000);

        // Pre-fill user name
        document.getElementById('userName').value = 'User ' + myUserId.split('-')[1];

        // WebRTC Config
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                return true;
            } catch (err) {
                console.error('Error accessing media devices:', err);
                alert('Could not access camera/microphone');
                return false;
            }
        }

        async function joinRoom() {
            if (!localStream) {
                const success = await startLocalStream();
                if (!success) return;
            }

            const roomId = document.getElementById('roomId').value;
            const userName = document.getElementById('userName').value;

            // Connect to Socket
            socket = io(`${API_URL}/meeting`, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                document.getElementById('connectionStatus').innerText = 'â€¢ Connected';
                document.getElementById('connectionStatus').style.color = '#81c995';
                
                socket.emit('join-room', {
                    roomId,
                    userId: myUserId,
                    userName,
                    productCategory: 'General'
                });

                updateUI(true);
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').innerText = 'â€¢ Disconnected';
                document.getElementById('connectionStatus').style.color = '#f28b82';
                updateUI(false);
            });

            // Socket Events
            socket.on('user-joined', async (data) => {
                console.log('User joined:', data);
                if (data.socketId === socket.id) return;
                createPeerConnection(data.socketId, data.userName, true);
            });

            socket.on('user-left', (data) => {
                console.log('User left:', data);
                removeRemoteVideo(data.socketId);
                if (peerConnections.has(data.socketId)) {
                    peerConnections.get(data.socketId).close();
                    peerConnections.delete(data.socketId);
                }
            });

            socket.on('room-users', (data) => {
                console.log('Existing users:', data);
                data.users.forEach(user => {
                    createPeerConnection(user.socketId, user.userName, false);
                });
            });

            // WebRTC Signaling
            socket.on('offer', async (data) => {
                const pc = createPeerConnection(data.senderSocketId, data.senderUserName, false);
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('answer', {
                    answer,
                    targetSocketId: data.senderSocketId,
                    roomId
                });
            });

            socket.on('answer', async (data) => {
                const pc = peerConnections.get(data.senderSocketId);
                if (pc) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });

            socket.on('ice-candidate', async (data) => {
                const pc = peerConnections.get(data.senderSocketId);
                if (pc) {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            });
        }

        function createPeerConnection(socketId, userName, isInitiator) {
            if (peerConnections.has(socketId)) return peerConnections.get(socketId);

            console.log(`Creating PeerConnection for ${userName} (${socketId})`);
            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections.set(socketId, pc);

            // Add local tracks
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        targetSocketId: socketId,
                        roomId: document.getElementById('roomId').value
                    });
                }
            };

            // Handle Remote Stream
            pc.ontrack = (event) => {
                console.log('Received remote track');
                addRemoteVideo(socketId, userName, event.streams[0]);
            };

            // Create Offer if initiator
            if (isInitiator) {
                pc.createOffer().then(offer => {
                    pc.setLocalDescription(offer);
                    socket.emit('offer', {
                        offer,
                        targetSocketId: socketId,
                        roomId: document.getElementById('roomId').value
                    });
                });
            }

            return pc;
        }

        function addRemoteVideo(socketId, userName, stream) {
            const grid = document.getElementById('videoGrid');
            if (document.getElementById(`video-${socketId}`)) return;

            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `card-${socketId}`;
            
            const video = document.createElement('video');
            video.id = `video-${socketId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;

            const label = document.createElement('div');
            label.className = 'card-label';
            label.innerText = userName;

            card.appendChild(video);
            card.appendChild(label);
            grid.appendChild(card);
        }

        function removeRemoteVideo(socketId) {
            const card = document.getElementById(`card-${socketId}`);
            if (card) card.remove();
        }

        function updateUI(connected) {
            document.getElementById('joinBtn').disabled = connected;
            document.getElementById('leaveBtn').disabled = !connected;
            document.getElementById('audioBtn').disabled = !connected;
            document.getElementById('videoBtn').disabled = !connected;
            document.getElementById('roomId').disabled = connected;
            document.getElementById('userName').disabled = connected;
        }

        function leaveRoom() {
            if (socket) socket.disconnect();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('videoGrid').innerHTML = `
                <div class="video-card">
                    <video id="localVideo" muted playsinline autoplay></video>
                    <div class="card-label">You</div>
                </div>
            `;
            peerConnections.clear();
            updateUI(false);
        }

        function toggleAudio() {
            isAudioMuted = !isAudioMuted;
            localStream.getAudioTracks().forEach(t => t.enabled = !isAudioMuted);
            document.getElementById('audioBtn').innerText = isAudioMuted ? 'ðŸŽ¤ Unmute' : 'ðŸŽ¤ Mute';
            document.getElementById('audioBtn').style.background = isAudioMuted ? '#f28b82' : '#8ab4f8';
        }

        function toggleVideo() {
            isVideoOff = !isVideoOff;
            localStream.getVideoTracks().forEach(t => t.enabled = !isVideoOff);
            document.getElementById('videoBtn').innerText = isVideoOff ? 'ðŸ“· Start Video' : 'ðŸ“· Stop Video';
            document.getElementById('videoBtn').style.background = isVideoOff ? '#f28b82' : '#8ab4f8';
        }
    </script>
</body>
</html>
